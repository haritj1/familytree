<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Archive: Tree, Timeline & Gallery</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --line-color: #bbb;
            --male-color: #3498db;
            --female-color: #e91e63;
            --bg-color: #f0f2f5;
            --sidebar-width: 350px;
        }

        body { margin: 0; overflow: hidden; background-color: var(--bg-color); font-family: 'Segoe UI', Tahoma, sans-serif; }

        /* --- Security & Loading --- */
        #password-overlay { position: fixed; inset: 0; background: #2c3e50; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        #password-overlay input { padding: 12px; border-radius: 4px; border: none; margin: 10px; text-align: center; width: 220px; }
        #tree-wrapper { opacity: 0; transition: opacity 0.5s; display: inline-block; }
        #tree-wrapper.ready { opacity: 1; }
        .hidden { display: none !important; }

        /* --- UI Controls --- */
        .ui-layer { position: fixed; z-index: 1000; padding: 20px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .ui-layer * { pointer-events: auto; }
        .btn-group { display: flex; gap: 8px; }
        .action-btn { cursor: pointer; background: #333; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 13px; }
        
        .dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; background: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 4px; top: 100%; }
        .dropdown-content a { color: black; padding: 12px; text-decoration: none; display: block; cursor: pointer; }
        .dropdown-content a:hover { background: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }

        /* --- Tree Visualization --- */
        #viewport { width: 100vw; height: 100vh; cursor: grab; }
        .tree ul { padding-top: 25px; position: relative; display: flex; justify-content: center; padding-left: 0; margin: 0; }
        .tree li { text-align: center; list-style-type: none; position: relative; padding: 25px 10px 0 10px; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 2px solid var(--line-color); width: 50%; height: 25px; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid var(--line-color); }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 2px solid var(--line-color); width: 0; height: 25px; }

        /* --- Card Styles --- */
        .couple-group { display: inline-flex; align-items: center; gap: 8px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #ddd; position: relative; }
        .marriage-label { font-size: 9px; color: #888; background: #fff; padding: 0 3px; position: relative; z-index: 2; border: 1px solid #eee; border-radius: 3px; }
        .spouse-connector { width: 20px; height: 2px; background: var(--line-color); flex-shrink: 0; }
        .person-card { width: 75px; text-align: center; cursor: pointer; position: relative; }
        .person-card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #ccc; display: block; margin: 0 auto; }
        .male img { border-color: var(--male-color); }
        .female img { border-color: var(--female-color); }
        .person-card span { display: block; font-size: 11px; font-weight: bold; margin-top: 5px; }
        .collapsed ul { display: none !important; }

        /* --- Sidebar & Gallery & Timeline --- */
        #sidebar { position: fixed; top: 0; right: -400px; width: var(--sidebar-width); height: 100%; background: white; z-index: 2000; padding: 30px; transition: 0.3s; box-shadow: -5px 0 15px rgba(0,0,0,0.1); overflow-y: auto; box-sizing: border-box; }
        #sidebar.open { right: 0; }
        #timeline-wrapper, #gallery-wrapper { height: 100vh; overflow-y: auto; padding: 100px 50px; background: var(--bg-color); box-sizing: border-box; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .gallery-item { background: white; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; }
        .gallery-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }

        .timeline-item { display: flex; align-items: center; gap: 20px; background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #333; max-width: 600px; margin-inline: auto; }
    </style>
</head>
<body>

<div id="password-overlay">
    <h2>Family Vault</h2>
    <input type="password" id="passInput" placeholder="Access Code">
    <button class="action-btn" onclick="checkPassword()" style="background:#27ae60;">Unlock Tree</button>
</div>

<div id="sidebar">
    <span onclick="closeSidebar()" style="cursor:pointer; float:right; font-size: 24px;">&times;</span>
    <img id="side-img" style="width:100%; border-radius:8px; margin-bottom: 20px;">
    <h2 id="side-name" style="margin: 0 0 5px 0;"></h2>
    <p id="side-meta" style="color: #666; font-size: 14px; margin-bottom: 20px;"></p>
    <hr style="border: 0; border-top: 1px solid #eee;">
    <p id="side-bio" style="line-height: 1.6; color: #444;"></p>
</div>

<div class="ui-layer">
    <div class="btn-group">
        <div class="dropdown">
            <button class="action-btn" id="viewToggle">Tree View ▼</button>
            <div class="dropdown-content">
                <a onclick="switchView('tree')">Tree View</a>
                <a onclick="switchView('timeline')">Timeline</a>
                <a onclick="switchView('gallery')">Gallery</a>
            </div>
        </div>
        <button class="action-btn" onclick="resetView()">Reset Tree</button>
        <button class="action-btn" onclick="exportTree()" style="background:#2ecc71;">Export Image</button>
    </div>
</div>

<div id="viewport">
    <div id="tree-wrapper" class="tree"></div>
</div>

<div id="timeline-wrapper" class="hidden"></div>
<div id="gallery-wrapper" class="hidden"><div class="gallery-grid" id="gallery-content"></div></div>

<script>
    const FAMILY_CODE = "Family2025";
    let globalData = null;
    const wrapper = document.getElementById('tree-wrapper');
    const viewport = d3.select("#viewport");
    const zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (e) => d3.select("#tree-wrapper").style("transform", `translate(${e.transform.x}px, ${e.transform.y}px) scale(${e.transform.k})`));

    function checkPassword() {
        if(document.getElementById('passInput').value === FAMILY_CODE) {
            document.getElementById('password-overlay').classList.add('hidden');
            init();
        } else { alert("Wrong code!"); }
    }

    function init() {
        fetch('familyData.json')
            .then(res => res.json())
            .then(data => {
                globalData = data;
                wrapper.appendChild(createTree(data));
                viewport.call(zoom);
                resetView();
                setTimeout(() => wrapper.classList.add('ready'), 200);
            });
    }

    function renderPerson(p) {
        const pData = JSON.stringify(p).replace(/"/g, '&quot;');
        return `
            <div class="person-card ${p.gender}" onclick="showDetails(${pData})">
                <img src="${p.img}" onerror="this.src='https://via.placeholder.com/60'">
                <span>${p.name}</span>
            </div>
        `;
    }

    function createTree(data) {
        const ul = document.createElement('ul');
        data.forEach(m => {
            const li = document.createElement('li');
            const group = document.createElement('div');
            group.className = 'couple-group';
            
            let html = renderPerson(m);
            if(m.spouses) {
                m.spouses.forEach(s => {
                    html += `<div class="spouse-connector"></div>`;
                    if(s.marriage) html += `<div class="marriage-label">${s.marriage}</div><div class="spouse-connector"></div>`;
                    html += renderPerson(s);
                });
            }
            group.innerHTML = html;
            li.appendChild(group);

            let children = m.children || [];
            if(m.spouses) m.spouses.forEach(s => { if(s.children) children = [...children, ...s.children]; });

            if(children.length > 0) {
                group.querySelector('img').onclick = (e) => { e.stopPropagation(); li.classList.toggle('collapsed'); };
                li.appendChild(createTree(children));
            }
            ul.appendChild(li);
        });
        return ul;
    }

    function switchView(type) {
        document.getElementById('viewport').classList.add('hidden');
        document.getElementById('timeline-wrapper').classList.add('hidden');
        document.getElementById('gallery-wrapper').classList.add('hidden');
        document.getElementById('viewToggle').innerText = type.toUpperCase() + " VIEW ▼";
        if(type === 'tree') document.getElementById('viewport').classList.remove('hidden');
        if(type === 'timeline') buildTimeline();
        if(type === 'gallery') buildGallery();
    }

    function buildTimeline() {
        const t = document.getElementById('timeline-wrapper');
        t.classList.remove('hidden');
        t.innerHTML = "<h2 style='text-align:center'>Chronological History</h2>";
        let list = [];
        const flat = (arr) => arr.forEach(p => { 
            list.push(p); 
            if(p.spouses) p.spouses.forEach(s => { list.push(s); if(s.children) flat(s.children); });
            if(p.children) flat(p.children);
        });
        flat(globalData);
        const unique = Array.from(new Map(list.map(p => [p.name, p])).values());
        unique.sort((a,b) => (parseInt(a.born)||0) - (parseInt(b.born)||0));

        unique.forEach(p => {
            t.innerHTML += `<div class="timeline-item" style="border-left-color:${p.gender==='male'?'var(--male-color)':'var(--female-color)'}">
                <div style="font-weight:bold; min-width:60px;">${p.born||'????'}</div>
                <img src="${p.img}" style="width:40px;height:40px;border-radius:50%" onerror="this.src='https://via.placeholder.com/40'">
                <div><strong>${p.name}</strong><br><small>${p.job||''}</small></div>
            </div>`;
        });
    }

    function buildGallery() {
        const g = document.getElementById('gallery-wrapper');
        const content = document.getElementById('gallery-content');
        g.classList.remove('hidden');
        content.innerHTML = "";
        let list = [];
        const flat = (arr) => arr.forEach(p => { 
            list.push(p); 
            if(p.spouses) p.spouses.forEach(s => { list.push(s); if(s.children) flat(s.children); });
            if(p.children) flat(p.children);
        });
        flat(globalData);
        Array.from(new Map(list.map(p => [p.name, p])).values()).forEach(p => {
            content.innerHTML += `<div class="gallery-item" onclick='showDetails(${JSON.stringify(p).replace(/"/g, "&quot;")})'><img src="${p.img}" onerror="this.src='https://via.placeholder.com/150'"><div>${p.name}</div></div>`;
        });
    }

    function showDetails(p) {
        document.getElementById('side-img').src = p.img;
        document.getElementById('side-name').innerText = p.name;
        document.getElementById('side-meta').innerText = `Born: ${p.born || 'Unknown'} | ${p.job || ''}`;
        document.getElementById('side-bio').innerText = p.bio || "No biography available.";
        document.getElementById('sidebar').classList.add('open');
    }

    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); }
    function resetView() { viewport.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(window.innerWidth/2-100, 50).scale(1)); }
    function exportTree() { html2canvas(wrapper, {useCORS: true}).then(c => { const l = document.createElement('a'); l.download='family-tree.png'; l.href=c.toDataURL(); l.click(); }); }
</script>
</body>
</html>
