<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Family Tree Builder</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Lucide Icons (via unpkg for React) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Prevent body scroll, handle in app */
            background-color: #f3f4f6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }

        /* Tree Connector Lines */
        .tree-line-down {
            position: absolute;
            top: 100%;
            left: 50%;
            width: 2px;
            height: 20px;
            background-color: #9ca3af;
            transform: translateX(-50%);
            z-index: 0;
        }

        .tree-line-up {
            position: absolute;
            bottom: 100%;
            left: 50%;
            width: 2px;
            height: 20px;
            background-color: #9ca3af;
            transform: translateX(-50%);
            z-index: 0;
        }
        
        /* Connector for siblings */
        .sibling-connector {
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #9ca3af;
            z-index: 0;
        }
        
        .first-child > .sibling-connector {
            left: 50%;
        }
        
        .last-child > .sibling-connector {
            right: 50%;
        }
        
        .only-child > .sibling-connector {
            display: none;
        }

        /* Marriage Line */
        .marriage-line {
            height: 2px;
            background-color: #9ca3af;
            width: 40px;
            align-self: center;
            margin: 0 10px;
            position: relative;
        }
        
        .marriage-line::after {
            content: '‚ù§Ô∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            background: #f3f4f6;
            padding: 0 4px;
        }

        /* Pattern Background for Canvas */
        .canvas-bg {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Mock Data ---
        const INITIAL_DATA = [
            { id: '1', name: 'Grandpa Joe', gender: 'male', isAlive: false, img: '', spouses: ['2'], parents: [], children: ['3', '4'] },
            { id: '2', name: 'Grandma Josephine', gender: 'female', isAlive: false, img: '', spouses: ['1'], parents: [], children: ['3', '4'] },
            { id: '3', name: 'Uncle Charlie', gender: 'male', isAlive: true, img: '', spouses: [], parents: ['1', '2'], children: [] },
            { id: '4', name: 'Mom', gender: 'female', isAlive: true, img: '', spouses: ['5'], parents: ['1', '2'], children: ['6', '7'] },
            { id: '5', name: 'Dad', gender: 'male', isAlive: true, img: '', spouses: ['4'], parents: ['8', '9'], children: ['6', '7'] }, // Spouse with parents
            { id: '6', name: 'Me', gender: 'male', isAlive: true, img: '', spouses: [], parents: ['4', '5'], children: [] },
            { id: '7', name: 'Sister', gender: 'female', isAlive: true, img: '', spouses: [], parents: ['4', '5'], children: [] },
            { id: '8', name: 'Dad\'s Father', gender: 'male', isAlive: false, img: '', spouses: ['9'], parents: [], children: ['5'] },
            { id: '9', name: 'Dad\'s Mother', gender: 'female', isAlive: false, img: '', spouses: ['8'], parents: [], children: ['5'] },
        ];

        // --- Helper Components ---

        const Icon = ({ name, className }) => {
            return <i className={`fa-solid fa-${name} ${className}`}></i>;
        };

        const Button = ({ onClick, children, className, variant = 'primary' }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all shadow-sm flex items-center gap-2 text-sm";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
                danger: "bg-red-500 text-white hover:bg-red-600",
                success: "bg-green-600 text-white hover:bg-green-700"
            };
            return (
                <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className }) => (
            <div className={`bg-white rounded-xl shadow-lg p-4 ${className}`}>
                {children}
            </div>
        );

        // --- Main Node Component ---
        
        const PersonNode = ({ 
            person, 
            isSpouse = false, 
            onClick, 
            searchMatch,
            onAddParent
        }) => {
            if (!person) return null;

            const isMale = person.gender === 'male';
            const statusColor = person.isAlive 
                ? (isMale ? 'bg-blue-50 border-blue-200' : 'bg-pink-50 border-pink-200')
                : 'bg-gray-100 border-gray-300 grayscale';
            
            const genderIcon = isMale ? 'mars' : 'venus';
            const genderText = isMale ? 'text-blue-500' : 'text-pink-500';
            
            return (
                <div 
                    onClick={(e) => { e.stopPropagation(); onClick(person); }}
                    className={`
                        relative w-48 border-2 rounded-xl p-3 cursor-pointer transition-all duration-200
                        hover:shadow-xl hover:-translate-y-1 group flex flex-col gap-2
                        ${statusColor}
                        ${searchMatch ? 'ring-4 ring-yellow-400 scale-105 z-10' : ''}
                    `}
                >
                    {/* Add Parent Button for Spouse (Contextual) */}
                    {isSpouse && person.parents.length === 0 && (
                        <button 
                            onClick={(e) => { e.stopPropagation(); onAddParent(person.id); }}
                            className="absolute -top-3 left-1/2 -translate-x-1/2 bg-green-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-20"
                            title="Add Parents"
                        >
                            <Icon name="plus" />
                        </button>
                    )}

                    <div className="flex items-center gap-3">
                        <div className="relative w-12 h-12 flex-shrink-0">
                            {person.img ? (
                                <img src={person.img} alt={person.name} className="w-full h-full object-cover rounded-full border border-gray-300" />
                            ) : (
                                <div className={`w-full h-full rounded-full flex items-center justify-center text-xl bg-white border ${isMale ? 'border-blue-200' : 'border-pink-200'}`}>
                                    <Icon name={isMale ? 'user' : 'user'} className={genderText} />
                                </div>
                            )}
                            {!person.isAlive && (
                                <div className="absolute -bottom-1 -right-1 bg-gray-600 text-white text-[10px] px-1 rounded-full">RIP</div>
                            )}
                        </div>
                        <div className="flex-1 min-w-0">
                            <h3 className="font-bold text-gray-800 truncate text-sm" title={person.name}>{person.name}</h3>
                            <div className="flex items-center gap-1 text-xs text-gray-500">
                                <Icon name={genderIcon} className={genderText} />
                                <span>{isMale ? 'Male' : 'Female'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Recursive Tree Component ---

        const FamilyBranch = ({ 
            rootId, 
            data, 
            onNodeClick, 
            searchQuery,
            onAddParent,
            level = 0
        }) => {
            const person = data.find(p => p.id === rootId);
            if (!person) return null;

            // Find Spouses
            const spouses = person.spouses.map(id => data.find(p => p.id === id)).filter(Boolean);
            
            // Find Children (Common children of this person and their spouses)
            // Note: In a complex tree, children might belong to specific couples. 
            // For simplicity here, we list all children of the 'root' person.
            const children = person.children.map(id => data.find(p => p.id === id)).filter(Boolean);

            const isMatch = searchQuery && person.name.toLowerCase().includes(searchQuery.toLowerCase());

            // Helper to render ancestors for a spouse (The "In-Laws" branch)
            const renderSpouseAncestors = (spouse) => {
                if (!spouse.parents || spouse.parents.length === 0) return null;
                // Just showing immediate parents for visual simplicity in this mode
                return (
                    <div className="flex justify-center gap-4 mb-8 relative">
                        {/* Line connecting parents to spouse */}
                         <div className="absolute top-full left-1/2 w-0.5 h-8 bg-gray-400 -translate-x-1/2"></div>
                        
                        {spouse.parents.map(pid => {
                            const parent = data.find(p => p.id === pid);
                            if (!parent) return null;
                            return (
                                <PersonNode 
                                    key={pid} 
                                    person={parent} 
                                    onClick={onNodeClick} 
                                    searchMatch={searchQuery && parent.name.toLowerCase().includes(searchQuery.toLowerCase())}
                                    onAddParent={onAddParent}
                                />
                            );
                        })}
                    </div>
                );
            };

            return (
                <div className="flex flex-col items-center mx-4">
                    {/* Couple Container */}
                    <div className="flex items-end gap-2 relative mb-12">
                         {/* Connector to Children */}
                         {children.length > 0 && <div className="tree-line-down" />}

                        {/* Main Person */}
                        <div className="relative">
                             {/* Connector from Parent (Handled by parent level css usually, but needed for visual clarity) */}
                            <PersonNode 
                                person={person} 
                                onClick={onNodeClick} 
                                searchMatch={isMatch}
                                onAddParent={onAddParent}
                            />
                        </div>

                        {/* Spouses */}
                        {spouses.map(spouse => {
                             const spouseMatch = searchQuery && spouse.name.toLowerCase().includes(searchQuery.toLowerCase());
                             return (
                                <div key={spouse.id} className="flex flex-col items-center">
                                    {/* Spouse Parents (Upward expansion) */}
                                    {renderSpouseAncestors(spouse)}
                                    
                                    <div className="flex items-center">
                                        <div className="marriage-line" title="Married"></div>
                                        <PersonNode 
                                            person={spouse} 
                                            isSpouse={true}
                                            onClick={onNodeClick} 
                                            searchMatch={spouseMatch}
                                            onAddParent={onAddParent}
                                        />
                                    </div>
                                </div>
                             );
                        })}
                    </div>

                    {/* Children Container */}
                    {children.length > 0 && (
                        <div className="flex relative pt-4">
                            {/* Horizontal Line connecting siblings */}
                            <div className="absolute top-0 left-4 right-4 h-0.5 bg-gray-400 hidden"></div>
                            
                            {children.map((child, index) => {
                                // Determine styling for connector lines
                                const isFirst = index === 0;
                                const isLast = index === children.length - 1;
                                const isOnly = children.length === 1;
                                const className = `flex flex-col items-center relative px-4 ${isFirst ? 'first-child' : ''} ${isLast ? 'last-child' : ''} ${isOnly ? 'only-child' : ''}`;

                                return (
                                    <div key={child.id} className={className}>
                                        <div className="sibling-connector"></div>
                                        <div className="tree-line-up"></div>
                                        <FamilyBranch 
                                            rootId={child.id} 
                                            data={data} 
                                            onNodeClick={onNodeClick}
                                            searchQuery={searchQuery}
                                            onAddParent={onAddParent}
                                            level={level + 1}
                                        />
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // --- Edit Modal ---
        
        const EditModal = ({ isOpen, onClose, person, onSave, onDelete, allPeople, onAddRelation }) => {
            if (!isOpen || !person) return null;

            const [formData, setFormData] = useState({ ...person });
            const [activeTab, setActiveTab] = useState('details'); // details, relations

            useEffect(() => {
                setFormData({ ...person });
            }, [person]);

            const handleChange = (e) => {
                const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                setFormData({ ...formData, [e.target.name]: value });
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData({ ...formData, img: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="text-xl font-bold text-gray-800">Edit Person</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><Icon name="times" /></button>
                        </div>
                        
                        <div className="flex border-b">
                            <button 
                                className={`flex-1 py-3 font-medium text-sm ${activeTab === 'details' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:bg-gray-50'}`}
                                onClick={() => setActiveTab('details')}
                            >
                                Details
                            </button>
                            <button 
                                className={`flex-1 py-3 font-medium text-sm ${activeTab === 'relations' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:bg-gray-50'}`}
                                onClick={() => setActiveTab('relations')}
                            >
                                Relationships
                            </button>
                        </div>

                        <div className="p-6 overflow-y-auto">
                            {activeTab === 'details' ? (
                                <form id="editForm" onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Name</label>
                                        <input required name="name" value={formData.name} onChange={handleChange} className="mt-1 block w-full rounded-md border border-gray-300 p-2 focus:ring-blue-500 focus:border-blue-500" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700">Gender</label>
                                            <select name="gender" value={formData.gender} onChange={handleChange} className="mt-1 block w-full rounded-md border border-gray-300 p-2">
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                        </div>
                                        <div className="flex items-center pt-6">
                                            <label className="flex items-center space-x-2 cursor-pointer">
                                                <input type="checkbox" name="isAlive" checked={formData.isAlive} onChange={handleChange} className="rounded text-blue-600 focus:ring-blue-500 h-4 w-4" />
                                                <span className="text-sm text-gray-700">Is Alive?</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Profile Image</label>
                                        <div className="mt-1 flex items-center space-x-4">
                                            {formData.img && <img src={formData.img} className="w-12 h-12 rounded-full object-cover" />}
                                            <input type="file" accept="image/*" onChange={handleFileChange} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                        </div>
                                        <div className="mt-2">
                                             <input placeholder="Or Paste Image URL" name="img" value={formData.img} onChange={handleChange} className="block w-full rounded-md border border-gray-300 p-2 text-xs text-gray-600" />
                                        </div>
                                    </div>
                                </form>
                            ) : (
                                <div className="space-y-6">
                                    <div>
                                        <h4 className="font-semibold text-gray-700 mb-2">Add Connections</h4>
                                        <div className="grid grid-cols-2 gap-2">
                                            <Button variant="secondary" onClick={() => onAddRelation(person.id, 'spouse')}>
                                                <Icon name="ring" /> Add Spouse
                                            </Button>
                                            <Button variant="secondary" onClick={() => onAddRelation(person.id, 'child')}>
                                                <Icon name="baby" /> Add Child
                                            </Button>
                                            <Button variant="secondary" onClick={() => onAddRelation(person.id, 'parent')}>
                                                <Icon name="user-plus" /> Add Parent
                                            </Button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-semibold text-gray-700 mb-2">Existing Connections</h4>
                                        <ul className="text-sm space-y-1">
                                            {person.spouses.map(id => {
                                                const p = allPeople.find(x => x.id === id);
                                                return <li key={id} className="text-gray-600"><Icon name="ring" className="mr-2 text-pink-500"/> Spouse: {p?.name || 'Unknown'}</li>
                                            })}
                                            {person.children.map(id => {
                                                const p = allPeople.find(x => x.id === id);
                                                return <li key={id} className="text-gray-600"><Icon name="arrow-down" className="mr-2 text-blue-500"/> Child: {p?.name || 'Unknown'}</li>
                                            })}
                                            {person.parents.map(id => {
                                                const p = allPeople.find(x => x.id === id);
                                                return <li key={id} className="text-gray-600"><Icon name="arrow-up" className="mr-2 text-green-500"/> Parent: {p?.name || 'Unknown'}</li>
                                            })}
                                        </ul>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t bg-gray-50 flex justify-between">
                            <Button variant="danger" onClick={() => onDelete(person.id)}>Delete Person</Button>
                            <div className="flex gap-2">
                                <Button variant="secondary" onClick={onClose}>Cancel</Button>
                                {activeTab === 'details' && <Button onClick={() => document.getElementById('editForm').requestSubmit()}>Save Changes</Button>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---

        const App = () => {
            const [people, setPeople] = useState(INITIAL_DATA);
            const [scale, setScale] = useState(0.8);
            const [position, setPosition] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            const [searchQuery, setSearchQuery] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [jsonInput, setJsonInput] = useState('');
            const [showJsonModal, setShowJsonModal] = useState(false);
            
            const canvasRef = useRef(null);

            // Find the absolute root(s) - people with no parents in the current list
            // OR if it's a circular mess, pick the first one.
            const roots = useMemo(() => {
                const hasParents = new Set();
                people.forEach(p => p.children.forEach(c => hasParents.add(c)));
                
                // Also exclude spouses of roots from being separate roots if they are attached to a root
                // This logic handles the "display one main tree" approach.
                // We find nodes that:
                // 1. Are not children of anyone in the list
                // 2. Are not primarily displayed as a spouse of a node we've already picked
                
                let candidates = people.filter(p => !hasParents.has(p.id));
                
                // Filter out spouses of candidates to prevent double rendering at top level
                const finalRoots = [];
                const processed = new Set();

                candidates.forEach(p => {
                    if (processed.has(p.id)) return;
                    
                    // Check if this person is a spouse of someone already in finalRoots
                    const isSpouseOfProcessed = p.spouses.some(sId => processed.has(sId));
                    
                    if (!isSpouseOfProcessed) {
                        finalRoots.push(p);
                        processed.add(p.id);
                        p.spouses.forEach(sId => processed.add(sId));
                    }
                });

                return finalRoots;
            }, [people]);

            // --- Handlers ---

            const handleMouseDown = (e) => {
                if(e.target.closest('.interactive-node')) return; // Don't drag if clicking node
                setIsDragging(true);
                setDragStart({ x: e.clientX - position.x, y: e.clientY - position.y });
            };

            const handleMouseMove = (e) => {
                if (isDragging) {
                    setPosition({
                        x: e.clientX - dragStart.x,
                        y: e.clientY - dragStart.y
                    });
                }
            };

            const handleMouseUp = () => setIsDragging(false);

            const handleWheel = (e) => {
                // e.preventDefault(); // handled by passive:false in effect if needed, but react handles it
                const newScale = scale + (e.deltaY > 0 ? -0.1 : 0.1);
                setScale(Math.min(Math.max(0.2, newScale), 2));
            };
            
            const handleReset = () => {
                if(confirm("Are you sure? This will delete all data.")) {
                    setPeople([]);
                    setPosition({ x: 0, y: 0 });
                    setScale(1);
                }
            };

            const handleLoadDefault = () => setPeople(INITIAL_DATA);

            const handleSavePerson = (updatedPerson) => {
                setPeople(people.map(p => p.id === updatedPerson.id ? updatedPerson : p));
                setEditingId(null);
            };

            const handleDeletePerson = (id) => {
                if(!confirm("Delete this person?")) return;
                
                // Remove person
                const newPeople = people.filter(p => p.id !== id);
                
                // Clean up references
                newPeople.forEach(p => {
                    p.spouses = p.spouses.filter(sid => sid !== id);
                    p.children = p.children.filter(cid => cid !== id);
                    p.parents = p.parents.filter(pid => pid !== id);
                });
                
                setPeople(newPeople);
                setEditingId(null);
            };

            const handleAddRelation = (sourceId, type) => {
                const newId = Date.now().toString();
                const sourcePerson = people.find(p => p.id === sourceId);
                
                const newPerson = {
                    id: newId,
                    name: "New Person",
                    gender: sourcePerson.gender === 'male' && type === 'spouse' ? 'female' : 'male',
                    isAlive: true,
                    img: '',
                    spouses: [],
                    parents: [],
                    children: []
                };

                let updatedPeople = [...people, newPerson];

                // Link them
                if (type === 'spouse') {
                    // Update Source
                    updatedPeople = updatedPeople.map(p => {
                        if (p.id === sourceId) return { ...p, spouses: [...p.spouses, newId] };
                        if (p.id === newId) return { ...p, spouses: [sourceId] };
                        return p;
                    });
                } else if (type === 'child') {
                    // Update Source (Parent)
                    updatedPeople = updatedPeople.map(p => {
                        if (p.id === sourceId) return { ...p, children: [...p.children, newId] };
                        if (p.id === newId) return { ...p, parents: [sourceId] }; // Add single parent initially
                        return p;
                    });
                    
                    // If source has a spouse, suggest adding them as parent too? 
                    // For simplicity, we just add to the clicked parent. The user can link the other parent manually or we assume logic.
                    // Better UX: Add to both parents if married.
                    if (sourcePerson.spouses.length > 0) {
                         const spouseId = sourcePerson.spouses[0];
                         updatedPeople = updatedPeople.map(p => {
                            if (p.id === spouseId) return { ...p, children: [...p.children, newId] };
                            if (p.id === newId) return { ...p, parents: [...p.parents, spouseId] };
                            return p;
                         });
                    }

                } else if (type === 'parent') {
                    updatedPeople = updatedPeople.map(p => {
                        if (p.id === sourceId) return { ...p, parents: [...p.parents, newId] };
                        if (p.id === newId) return { ...p, children: [sourceId] };
                        return p;
                    });
                }

                setPeople(updatedPeople);
                setEditingId(newId); // Open edit for new person
            };

            const handleJsonImport = () => {
                try {
                    const data = JSON.parse(jsonInput);
                    if (Array.isArray(data)) {
                        setPeople(data);
                        setShowJsonModal(false);
                    } else {
                        alert("Invalid JSON format. Expected an array.");
                    }
                } catch (e) {
                    alert("JSON Parse Error: " + e.message);
                }
            };

            const handleExport = () => {
                setJsonInput(JSON.stringify(people, null, 2));
                setShowJsonModal(true);
            };

            // Add new unrelated person
            const handleAddNew = () => {
                const newId = Date.now().toString();
                const newPerson = {
                    id: newId, name: "New Person", gender: 'male', isAlive: true, img: '', spouses: [], parents: [], children: []
                };
                setPeople([...people, newPerson]);
                setEditingId(newId);
            };

            return (
                <div className="h-screen flex flex-col overflow-hidden">
                    {/* Toolbar */}
                    <div className="bg-white shadow-md p-4 z-10 flex flex-wrap gap-4 items-center justify-between">
                        <div className="flex items-center gap-2">
                            <h1 className="text-xl font-bold text-gray-800 mr-4">üå≥ Family Tree</h1>
                            <Button onClick={handleAddNew}><Icon name="plus" /> Add Person</Button>
                            <Button variant="secondary" onClick={handleExport}><Icon name="code" /> JSON Data</Button>
                        </div>

                        <div className="flex items-center gap-4">
                            <div className="relative">
                                <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                <input 
                                    type="text" 
                                    placeholder="Search family..." 
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none w-64"
                                />
                            </div>
                            
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                <button onClick={() => setScale(s => s - 0.1)} className="p-2 hover:bg-white rounded shadow-sm"><Icon name="minus" /></button>
                                <span className="px-3 py-2 text-sm font-mono min-w-[60px] text-center">{Math.round(scale * 100)}%</span>
                                <button onClick={() => setScale(s => s + 0.1)} className="p-2 hover:bg-white rounded shadow-sm"><Icon name="plus" /></button>
                            </div>
                            
                            <Button variant="secondary" onClick={() => { setPosition({x:0,y:0}); setScale(1); }}>Fit</Button>
                            <Button variant="danger" onClick={handleReset}><Icon name="trash" /></Button>
                        </div>
                    </div>

                    {/* Canvas */}
                    <div 
                        className="flex-1 relative overflow-hidden bg-gray-50 cursor-move canvas-bg"
                        onMouseDown={handleMouseDown}
                        onMouseMove={handleMouseMove}
                        onMouseUp={handleMouseUp}
                        onMouseLeave={handleMouseUp}
                        onWheel={handleWheel}
                        ref={canvasRef}
                    >
                        <div 
                            style={{
                                transform: `translate(${position.x}px, ${position.y}px) scale(${scale})`,
                                transformOrigin: '0 0',
                                transition: isDragging ? 'none' : 'transform 0.2s ease-out'
                            }}
                            className="absolute top-0 left-0 min-w-full min-h-full p-20 flex justify-center items-start"
                        >
                            <div className="flex gap-20">
                                {roots.map(root => (
                                    <FamilyBranch 
                                        key={root.id} 
                                        rootId={root.id} 
                                        data={people} 
                                        onNodeClick={(p) => setEditingId(p.id)}
                                        searchQuery={searchQuery}
                                        onAddParent={(id) => handleAddRelation(id, 'parent')}
                                    />
                                ))}
                                {people.length === 0 && (
                                    <div className="text-center mt-20 text-gray-400">
                                        <Icon name="tree" className="text-6xl mb-4" />
                                        <p>Tree is empty. Add a person or import JSON.</p>
                                        <div className="mt-4">
                                            <Button onClick={handleLoadDefault}>Load Example Data</Button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Legend */}
                        <div className="absolute bottom-4 right-4 bg-white/90 backdrop-blur p-4 rounded-lg shadow-lg border text-xs text-gray-600 z-10">
                            <div className="flex items-center gap-2 mb-1"><span className="w-3 h-3 bg-blue-100 border border-blue-300 rounded block"></span> Male</div>
                            <div className="flex items-center gap-2 mb-1"><span className="w-3 h-3 bg-pink-100 border border-pink-300 rounded block"></span> Female</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 bg-gray-100 border border-gray-400 grayscale rounded block"></span> Deceased</div>
                        </div>
                    </div>

                    {/* Modals */}
                    <EditModal 
                        isOpen={!!editingId} 
                        person={people.find(p => p.id === editingId)} 
                        allPeople={people}
                        onClose={() => setEditingId(null)}
                        onSave={handleSavePerson}
                        onDelete={handleDeletePerson}
                        onAddRelation={handleAddRelation}
                    />

                    {showJsonModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-2xl">
                                <h2 className="text-lg font-bold mb-4">JSON Data</h2>
                                <textarea 
                                    className="w-full h-64 p-4 border rounded font-mono text-sm bg-gray-50 mb-4"
                                    value={jsonInput}
                                    onChange={(e) => setJsonInput(e.target.value)}
                                ></textarea>
                                <div className="flex justify-end gap-2">
                                    <Button variant="secondary" onClick={() => setShowJsonModal(false)}>Cancel</Button>
                                    <Button onClick={handleJsonImport}>Import JSON</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
