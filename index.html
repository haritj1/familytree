<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Family Tree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --male-color: #e3f2fd;
            --male-border: #2196f3;
            --female-color: #fce4ec;
            --female-border: #e91e63;
            --living-status: #4caf50;
            --deceased-status: #757575;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        /* --- LOGIN OVERLAY --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            width: 300px;
        }

        .login-box h2 {
            margin-top: 0;
            color: #333;
        }

        .login-box input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .login-box button {
            width: 100%;
            padding: 10px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .login-box button:hover {
            background: #1976d2;
        }

        /* Hide main content initially */
        #controls, #tree-container {
            display: none;
        }

        /* Controls Bar */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            /* display: flex;  Set via JS after login */
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: #444; }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .button-row {
            display: flex;
            gap: 5px;
            justify-content: space-between;
        }

        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        button {
            padding: 8px 16px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            flex: 1;
        }

        button:hover { background-color: #1976d2; }
        button.secondary { background-color: #607d8b; }
        button.secondary:hover { background-color: #455a64; }
        button.action-btn { font-size: 0.9em; padding: 6px 10px; }

        /* SVG Styles */
        #tree-container {
            width: 100vw;
            height: 100vh;
            cursor: grab;
        }
        #tree-container:active { cursor: grabbing; }

        .node rect {
            stroke-width: 2px;
            transition: all 0.3s;
        }

        .node text {
            font-size: 12px;
            font-family: sans-serif;
            text-anchor: middle;
            pointer-events: none;
            fill: var(--text-color);
        }

        /* Image styling - Square */
        .node image {
            /* clip-path: circle(40%); Removed for square images */
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        /* Search Highlight */
        @keyframes rainbow { 
            0% { stroke: #ff0000; stroke-width: 6px; }
            14% { stroke: #ff7f00; stroke-width: 6px; }
            28% { stroke: #ffff00; stroke-width: 6px; }
            42% { stroke: #00ff00; stroke-width: 6px; }
            57% { stroke: #0000ff; stroke-width: 6px; }
            71% { stroke: #4b0082; stroke-width: 6px; }
            85% { stroke: #9400d3; stroke-width: 6px; }
            100% { stroke: #ff0000; stroke-width: 6px; }
        }

        .rainbow-highlight rect {
            animation: rainbow 2s linear infinite;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
        }
        
        .deceased-img { filter: grayscale(100%); opacity: 0.8; }

        /* Card Content & Bounce Animation */
        .card-content {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .person-group:hover .card-content {
            transform: translateY(-8px);
        }
        .person-group.has-children {
            cursor: pointer;
        }
        .person-group.collapsed rect {
            stroke-dasharray: 5,5; /* Visual hint for collapsed state */
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 6px;
            pointer-events: none;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            max-width: 200px;
            z-index: 1000;
        }
        
        .tooltip strong {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            border-bottom: 1px solid #555;
            padding-bottom: 3px;
        }

        /* Print Styles */
        @media print {
            @page {
                size: landscape;
                margin: 0;
            }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact;
            }
            #controls, #tooltip, #login-overlay { 
                display: none !important; 
            }
            #tree-container {
                width: 100%;
                height: 100%;
                border: none;
                display: block !important;
            }
            svg {
                height: 100vh;
                width: 100vw;
            }
        }

    </style>
</head>
<body>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>Secured Family Tree</h2>
            <p>Please enter the password to view.</p>
            <input type="password" id="passwordInput" placeholder="Password">
            <button onclick="checkPassword()">Unlock</button>
        </div>
    </div>

    <div id="controls">
        <h2>Family Tree Controls</h2>
        
        <div class="control-group">
            <input type="text" id="searchInput" placeholder="Search name...">
            <button onclick="searchNode()">Search</button>
        </div>
        
        <div class="button-row">
            <button class="action-btn" onclick="expandAll()">Expand All</button>
            <button class="action-btn" onclick="collapseAll()">Collapse All</button>
        </div>

        <div class="control-group">
            <button class="secondary" onclick="resetView()">Reset View</button>
        </div>
        
        <div class="control-group">
            <button class="secondary" onclick="printView()">Print / Save PDF</button>
        </div>
    </div>

    <div id="tree-container"></div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        // --- 1. CONFIGURATION & STATE ---
        const config = {
            nodeWidth: 160,
            nodeHeight: 80,
            imageSize: 40,
            siblingGap: 20, 
            levelGap: 200, 
            spouseGap: 200
        };

        let svg, g, zoom;
        let rootData;

        // --- 2. SAMPLE DATA ---
        const sampleData = {
          "name": "Laxmana chetty",
          "gender": "male",
          "status": "deceased",
          "spouse": {
            "name": "Laxmi Ammal",
            "gender": "female",
            "status": "deceased"
          },
          "children": [
            {
              "name": "Veerasamy",
              "gender": "male",
              "status": "deceased",
              "spouse": {
                "name": "Ellammal",
                "gender": "female",
                "status": "deceased"
              },
              "children": [
                { "name": "Daughter 1", "gender": "female", "status": "deceased" },
                { "name": "Daughter 2", "gender": "female", "status": "deceased" },
                { "name": "Govindasamy", "gender": "male", "status": "deceased" },
                { "name": "Munusamy", "gender": "male", "status": "deceased" },
                {
                  "name": "Ayyasamy",
                  "gender": "male",
                  "status": "deceased",
                  "spouse": {
                    "name": "Sengammal",
                    "gender": "female",
                    "status": "deceased"
                  },
                  "children": [
                    {
                      "name": "Parthasarathy",
                      "gender": "male",
                      "status": "deceased",
                      "spouse": {
                        "name": "Ammani Ammal",
                        "gender": "female",
                        "status": "deceased"
                      },
                      "children": [
                        { "name": "Adhikesavulu", "gender": "male", "status": "deceased" },
                        { "name": "Kothandam", "gender": "male", "status": "deceased" },
                        { "name": "Balaraman", "gender": "male", "status": "deceased" },
                        { "name": "Thayarammal", "gender": "female", "status": "deceased" },
                        {
                          "name": "Muthukrishnan",
                          "gender": "male",
                          "status": "deceased",
                          "spouse": {
                            "name": "Ranganayagi",
                            "gender": "female",
                            "status": "deceased"
                          },
                          "children": [
                            { "name": "Male1", "gender": "male", "status": "deceased" },
                            { "name": "Female2", "gender": "female", "status": "deceased" },
                            { "name": "Male3", "gender": "male", "status": "deceased" },
                            {
                              "name": "Loganathan",
                              "gender": "male",
                              "status": "deceased",
                              "spouse": {
                                "name": "Savithiri",
                                "gender": "female",
                                "status": "deceased"
                              },
                              "children": [
                                {
                                  "name": "Janakiraman TL",
                                  "gender": "male",
                                  "status": "deceased",
                                  "birthYear": 1945,
                                  "spouse": { "name": "Susila K", "gender": "female", "status": "deceased", "birthYear": 1947 },
                                  "children": [
                                    { "name": "Child 1", "gender": "female", "status": "deceased" },
                                    {
                                      "name": "Srividya TJ",
                                      "gender": "female",
                                      "status": "living",
                                      "spouse": { "name": "Vasudevan K", "gender": "male", "status": "living" },
                                      "children": [ { "name": "Harini V", "gender": "female", "status": "living" } ]
                                    },
                                    {
                                      "name": "Ravisankar TJ",
                                      "gender": "male",
                                      "status": "living",
                                      "spouse": { "name": "Durga PR", "gender": "female", "status": "living" },
                                      "children": [ { "name": "Akshitha R", "gender": "female", "status": "living" } ]
                                    },
                                    {
                                      "name": "Hariprasad TJ",
                                      "gender": "male",
                                      "status": "living",
                                      "spouse": { "name": "Supriya B", "gender": "female", "status": "living" },
                                      "children": [ { "name": "Nidheesh Krishna H", "gender": "male", "status": "living" } ]
                                    }
                                  ]
                                },
                                {
                                  "name": "Ethiraj TL",
                                  "gender": "male",
                                  "status": "living",
                                  "birthYear": 1947,
                                  "spouse": { "name": "Saraswathy", "gender": "female", "status": "living" },
                                  "children": [
                                     {
                                        "name": "Dhivakar TE",
                                        "gender": "male",
                                        "status": "living",
                                        "spouse": { "name": "Sripriya", "gender": "female", "status": "living" },
                                        "children": [
                                            { "name": "Madhu", "gender": "female", "status": "living" },
                                            { "name": "Dhivesh", "gender": "male", "status": "living" }
                                        ]
                                     },
                                     {
                                        "name": "Deepa TE",
                                        "gender": "female",
                                        "status": "living",
                                        "spouse": { "name": "Senthil", "gender": "male", "status": "living" },
                                        "children": [
                                            { "name": "Aakash", "gender": "male", "status": "living" },
                                            { "name": "Namritha", "gender": "female", "status": "living" }
                                        ]
                                     }
                                  ]
                                },
                                { 
                                    "name": "Devaraj TL", 
                                    "gender": "male", 
                                    "status": "deceased", 
                                    "spouse": { "name": "Haripriya", "gender": "female", "status": "living" },
                                    "children": [
                                        { 
                                            "name": "Saranya D", 
                                            "gender": "female", 
                                            "status": "living", 
                                            "spouse": { "name": "Raghu", "gender": "male", "status": "living" },
                                            "children": [
                                                { "name": "Sai 1", "gender": "male", "status": "living" },
                                                { "name": "Sai Krishnav", "gender": "male", "status": "living" }
                                            ]
                                        }
                                    ]
                                },
                                { 
                                    "name": "Parthasarathy TL", 
                                    "gender": "male", 
                                    "status": "living", 
                                    "spouse": { "name": "Hemavathy", "gender": "female", "status": "deceased" },
                                    "children": [
                                        { 
                                            "name": "Brindha P", 
                                            "gender": "female", 
                                            "status": "living", 
                                            "spouse": { "name": "Rajesh", "gender": "male", "status": "living" },
                                            "children": [
                                                { "name": "", "gender": "female", "status": "living" },
                                                { "name": "", "gender": "male", "status": "living" }
                                            ]
                                        },
                                        { 
                                            "name": "Indumathi P", 
                                            "gender": "female", 
                                            "status": "living", 
                                            "spouse": { "name": "Rupesh", "gender": "male", "status": "living" },
                                            "children": [
                                                { "name": "", "gender": "male", "status": "living" },
                                                { "name": "", "gender": "male", "status": "living" }
                                            ]
                                        },
                                        { 
                                            "name": "Aravind P", 
                                            "gender": "male", 
                                            "status": "living", 
                                            "spouse": { "name": "", "gender": "female", "status": "living" },
                                            "children": [
                                                { "name": "", "gender": "male", "status": "living" }
                                            ]
                                        }
                                    ]
                                },
                                { 
                                    "name": "Janarthanam TL", 
                                    "gender": "male", 
                                    "status": "living", 
                                    "spouse": { "name": "Shanthi", "gender": "female", "status": "living" },
                                    "children": [
                                        { 
                                            "name": "Anand TJ", 
                                            "gender": "male", 
                                            "status": "living", 
                                            "spouse": { "name": "Priya", "gender": "female", "status": "living" },
                                            "children": [
                                                { "name": "", "gender": "female", "status": "living" }
                                            ]
                                        },
                                        { 
                                            "name": "Suganya TJ", 
                                            "gender": "female", 
                                            "status": "living", 
                                            "spouse": { "name": "Parthiban", "gender": "male", "status": "living" },
                                            "children": [
                                                { "name": "", "gender": "male", "status": "living" }
                                            ]
                                        }
                                    ]
                                },
                                { 
                                    "name": "Revathy", 
                                    "gender": "female", 
                                    "status": "living", 
                                    "spouse": { "name": "Murugan", "gender": "male", "status": "living" },
                                    "children": [
                                        { 
                                            "name": "Balaji M", 
                                            "gender": "male", 
                                            "status": "living", 
                                            "spouse": { "name": "Padma", "gender": "female", "status": "living" },
                                            "children": [
                                                { "name": "", "gender": "male", "status": "living" },
                                                { "name": "", "gender": "female", "status": "living" }
                                            ]
                                        },
                                        { 
                                            "name": "Udayakumar M", 
                                            "gender": "male", 
                                            "status": "living", 
                                            "spouse": { "name": "Preethi", "gender": "female", "status": "living" },
                                            "children": [
                                                { "name": "", "gender": "female", "status": "living" },
                                                { "name": "", "gender": "female", "status": "living" }
                                            ]
                                        }
                                    ]
                                },
                                { 
                                    "name": "Rathapathy TL", 
                                    "gender": "male", 
                                    "status": "living", 
                                    "spouse": { "name": "Prema", "gender": "female", "status": "living" },
                                    "children": [
                                        { 
                                            "name": "Sindhu R", 
                                            "gender": "female", 
                                            "status": "living", 
                                            "spouse": { "name": "Hari", "gender": "male", "status": "living" },
                                            "children": [
                                                { "name": "HimaBindu", "gender": "female", "status": "living" }
                                            ]
                                        },
                                        { "name": "Hima", "gender": "female", "status": "deceased" }
                                    ]
                                },
                                { 
                                    "name": "Hemachandran TL", 
                                    "gender": "male", 
                                    "status": "living", 
                                    "spouse": { "name": "Poonghuzhali", "gender": "female", "status": "living" },
                                    "children": [
                                        { 
                                            "name": "Divya TH", 
                                            "gender": "female", 
                                            "status": "living", 
                                            "spouse": { "name": "Vinoth", "gender": "male", "status": "living" },
                                            "children": [
                                                { "name": "Hashika", "gender": "female", "status": "living" }
                                            ]
                                        },
                                        { "name": "Sathish Kumar TH", "gender": "male", "status": "living" }
                                    ]
                                },
                                { 
                                    "name": "Chandhravathy", 
                                    "gender": "female", 
                                    "status": "living", 
                                    "spouse": { "name": "Balakrishnan", "gender": "male", "status": "living" },
                                    "children": [
                                        { "name": "Supriya B", "gender": "female", "status": "living", "spouse": { "name": "Hariprasad TJ", "gender": "male", "status": "living" } },
                                        { 
                                            "name": "Vishnupriya B", 
                                            "gender": "female", 
                                            "status": "living", 
                                            "spouse": { "name": "Anand Kumar", "gender": "male", "status": "living" },
                                            "children": [
                                                { "name": "Varish", "gender": "male", "status": "living" }
                                            ]
                                        }
                                    ]
                                }
                              ]
                            },
                            { "name": "Narasimmalu", "gender": "male", "status": "deceased" },
                            { "name": "Devagi", "gender": "female", "status": "deceased" },
                            { "name": "Sulochana", "gender": "female", "status": "deceased" }
                          ]
                        },
                        {
                          "name": "Ramasamy",
                          "gender": "male",
                          "status": "deceased",
                          "spouse": {
                            "name": "Laxmi",
                            "gender": "female",
                            "status": "deceased"
                          }
                        }
                      ]
                    },
                    { "name": "Devaraj", "gender": "male", "status": "deceased" }
                  ]
                }
              ]
            }
          ]
        };

        // --- 3. INITIALIZATION ---
        window.onload = function() {
            // Focus password input on load
            document.getElementById('passwordInput').focus();

            // Add Enter key listener for password submit
            document.getElementById("passwordInput").addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    checkPassword();
                }
            });
        };

        // --- PASSWORD PROTECTION ---
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            // Simple visual gate - Password is '1234'
            if (password === 'TRLFamily1$') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('tree-container').style.display = 'block';
                startApp();
            } else {
                // Incorrect password action: Clear body and attempt close
                document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#2c3e50;color:white;font-family:sans-serif;"><h1>Access Denied</h1></div>';
                // Attempt to close window (often blocked by browsers if not opened by script)
                window.close();
            }
        }

        // --- APP STARTUP (After Login) ---
        function startApp() {
            initTree();

            // Add Enter key listener for search
            document.getElementById("searchInput").addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    searchNode();
                }
            });

            // Try to fetch 'familyData.json', fall back to sample if fails
            fetch('familyData.json')
                .then(response => {
                    if (!response.ok) throw new Error("File not found");
                    return response.json();
                })
                .then(data => drawTree(data))
                .catch(err => {
                    console.log("Using sample data (Local fetch blocked or file missing).");
                    drawTree(sampleData);
                });
        }

        function initTree() {
            const container = document.getElementById("tree-container");
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select("#tree-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(d3.zoom().on("zoom", (e) => {
                    g.attr("transform", e.transform);
                }))
                .on("dblclick.zoom", null); // Disable double click zoom

            g = svg.append("g").attr("transform", "translate(40,40)");
            
            // Set up zoom behavior reference
            zoom = d3.zoom().on("zoom", (e) => g.attr("transform", e.transform));
            svg.call(zoom);
        }

        // --- 4. DRAWING LOGIC ---
        function drawTree(data, isUpdate = false) {
            rootData = data;
            g.selectAll("*").remove(); // Clear previous tree for redraw

            // Create hierarchy
            const root = d3.hierarchy(data);

            // --- MINIMIZE DEFAULT: Collapse all children of root initially ---
            // Only runs once on first load
            if (!isUpdate && !window.treeInitialized) {
                if (root.children) {
                    // Use a recursive function that modifies the DATA structure for consistency
                    function initialCollapse(nodeData) {
                        if (nodeData.children) {
                            nodeData._children = nodeData.children;
                            nodeData._children.forEach(initialCollapse);
                            nodeData.children = null;
                        }
                    }
                    // Apply to children of root (keep root expanded)
                    if (data.children) {
                        data.children.forEach(initialCollapse);
                    }
                }
                window.treeInitialized = true;
                // Re-run hierarchy creation since we modified the data
                return drawTree(data, true);
            }

            // Create tree layout
            // UPDATE: Dynamic Separation Logic to reduce gaps
            const nodeSizeX = config.nodeWidth + config.siblingGap;
            
            const treeLayout = d3.tree()
                .nodeSize([nodeSizeX, config.levelGap])
                .separation((a, b) => {
                    let sep = 1; // Default separation
                    
                    // If the left node has a spouse, we need extra space
                    if (a.data.spouse) {
                        // Calculate total width needed: Spouse Offset + Spouse Width/2 + Gap + Next Node Width/2
                        const totalNeeded = config.spouseGap + config.nodeWidth + config.siblingGap;
                        sep = totalNeeded / nodeSizeX;
                    }
                    
                    return a.parent === b.parent ? sep : sep + 0.1;
                });

            treeLayout(root);

            // Handle initial zoom centering
            if (!isUpdate) {
                const containerWidth = document.getElementById("tree-container").clientWidth;
                // Since we start collapsed, root is single node, easier to center
                const initialX = containerWidth / 2 - root.x;
                const initialY = 100;
                svg.call(zoom.transform, d3.zoomIdentity.translate(initialX, initialY).scale(0.8));
            }

            // --- LINKS (Connectors) ---
            g.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => {
                    const parentX = d.source.data.spouse ? d.source.x + (config.spouseGap/2) : d.source.x;
                    const parentY = d.source.y + config.nodeHeight / 2;
                    const childX = d.target.x;
                    const childY = d.target.y - config.nodeHeight / 2;

                    return `M${parentX},${parentY} 
                            C${parentX},${(parentY + childY) / 2} 
                             ${childX},${(parentY + childY) / 2} 
                             ${childX},${childY}`;
                });

            // --- NODES ---
            const node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            // Function to render a single person card
            function renderPerson(selection, offsetX, offsetY, personData, isSpouse = false) {
                if (!personData) return;

                const group = selection.append("g")
                    .attr("transform", `translate(${offsetX}, ${offsetY})`)
                    .attr("class", "person-group")
                    .attr("data-name", personData.name.toLowerCase());

                // --- 1. CLICK TO TOGGLE CHILDREN (COLLAPSE/EXPAND) ---
                // Only enable for non-spouses (main lineage nodes) that have children (or hidden children)
                const hasChildren = personData.children || personData._children;
                if (!isSpouse && hasChildren) {
                    group.classed("has-children", true);
                    if (personData._children) group.classed("collapsed", true);
                    
                    group.on("click", function(event) {
                        event.stopPropagation(); // Prevent drag/zoom triggers if any
                        toggleChildren(personData);
                    });
                }

                // --- 2. BOUNCE & HOVER GROUP WRAPPER ---
                // We wrap content in 'card-content' to animate it without messing up D3 coordinates
                const contentGroup = group.append("g").attr("class", "card-content");

                // --- 3. TOOLTIP ---
                const tooltip = d3.select("#tooltip");
                group.on("mouseover", function(event) {
                    tooltip.transition().duration(200).style("opacity", 1);
                    
                    let tooltipHtml = `<strong>${personData.name}</strong>`;
                    tooltipHtml += `Gender: ${personData.gender}<br/>`;
                    if (personData.spouse) tooltipHtml += `Spouse: ${personData.spouse.name}<br/>`;
                    
                    tooltip.html(tooltipHtml)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mousemove", function(event) {
                     tooltip.style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().duration(500).style("opacity", 0);
                });


                const color = personData.gender === 'male' ? 'var(--male-color)' : 'var(--female-color)';
                const borderColor = personData.gender === 'male' ? 'var(--male-border)' : 'var(--female-border)';
                const statusColor = personData.status === 'living' ? 'var(--living-status)' : 'var(--deceased-status)';

                // Box
                contentGroup.append("rect")
                    .attr("width", config.nodeWidth)
                    .attr("height", config.nodeHeight)
                    .attr("x", -config.nodeWidth / 2)
                    .attr("y", -config.nodeHeight / 2)
                    .attr("rx", 10)
                    .attr("fill", color)
                    .attr("stroke", statusColor)
                    .attr("stroke-width", 3);

                // Image logic
                let imgSrc;
                const defaultMale = "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
                const defaultFemale = "https://cdn-icons-png.flaticon.com/512/4128/4128249.png";
                
                if (personData.img && personData.img.trim() !== "") {
                    imgSrc = personData.img.startsWith("http") ? personData.img : "images/" + personData.img;
                } else {
                    imgSrc = personData.gender === 'male' ? defaultMale : defaultFemale;
                }

                const img = contentGroup.append("image")
                    .attr("href", imgSrc)
                    .attr("width", config.imageSize)
                    .attr("height", config.imageSize)
                    .attr("x", -config.nodeWidth / 2 + 10)
                    .attr("y", -config.imageSize / 2)
                    .attr("preserveAspectRatio", "xMidYMid slice");

                if (personData.status === 'deceased') {
                    img.classed("deceased-img", true);
                }

                // Name - Moved up slightly
                contentGroup.append("text")
                    .attr("dy", "-12")
                    .attr("x", 15)
                    .style("font-weight", "bold")
                    .text(personData.name.length > 15 ? personData.name.substring(0,12)+"..." : personData.name);

                // --- INFO ROW: Age & Child Count ---
                let infoText = [];
                
                // Age Calculation
                if (personData.birthYear) {
                    const currentYear = new Date().getFullYear();
                    infoText.push(`Age: ${currentYear - personData.birthYear}`);
                }
                
                // Child Count Calculation
                const childCount = (personData.children || []).length + (personData._children || []).length;
                if (childCount > 0) {
                    infoText.push(`Children: ${childCount}`);
                }
                
                if (infoText.length > 0) {
                     contentGroup.append("text")
                        .attr("dy", "5")
                        .attr("x", 15)
                        .style("font-size", "10px")
                        .text(infoText.join(" | "));
                }

                // --- STATUS TEXT ---
                if (personData.status === 'deceased') {
                    contentGroup.append("text")
                        .attr("dy", "18")
                        .attr("x", 15)
                        .style("font-size", "10px")
                        .style("fill", "#666")
                        .style("font-style", "italic")
                        .text("Deceased");
                }
                
                // --- Collapse Indicator (Plus/Minus sign) ---
                if (!isSpouse && hasChildren) {
                    const indicatorColor = personData._children ? "#4caf50" : "#f44336"; // Green for expand, Red for collapse
                    const sign = personData._children ? "+" : "-";
                    
                    const indGroup = contentGroup.append("g")
                        .attr("transform", `translate(${config.nodeWidth/2 - 15}, ${config.nodeHeight/2 - 15})`);
                    
                    indGroup.append("circle")
                        .attr("r", 8)
                        .attr("fill", "white")
                        .attr("stroke", indicatorColor);
                        
                    indGroup.append("text")
                        .attr("dy", 4)
                        .attr("text-anchor", "middle")
                        .style("font-size", "12px")
                        .style("font-weight", "bold")
                        .style("fill", indicatorColor)
                        .text(sign);
                }

                // --- SPOUSE PARENTS ---
                if (isSpouse && personData.parents && personData.parents.length > 0) {
                    const pWidth = 60; 
                    const pHeight = 30;
                    
                    contentGroup.append("line")
                        .attr("x1", 0).attr("y1", -config.nodeHeight/2)
                        .attr("x2", 0).attr("y2", -config.nodeHeight/2 - 20)
                        .attr("stroke", "#999");

                    personData.parents.forEach((parent, i) => {
                        const pX = (i === 0 ? -1 : 1) * (pWidth/2 + 5);
                        const pY = -config.nodeHeight/2 - 40;

                        const pGroup = contentGroup.append("g")
                            .attr("transform", `translate(${pX}, ${pY})`);

                        pGroup.append("rect")
                            .attr("width", pWidth)
                            .attr("height", pHeight)
                            .attr("x", -pWidth/2)
                            .attr("y", -pHeight/2)
                            .attr("fill", parent.gender === 'male' ? '#e3f2fd' : '#fce4ec')
                            .attr("stroke", "#ccc");
                        
                        pGroup.append("text")
                            .attr("dy", "4")
                            .style("font-size", "8px")
                            .text(parent.name.split(' ')[0]);

                        contentGroup.append("line")
                            .attr("x1", 0).attr("y1", -config.nodeHeight/2 - 20)
                            .attr("x2", pX).attr("y2", -config.nodeHeight/2 - 20)
                            .attr("stroke", "#999");
                        
                        contentGroup.append("line")
                            .attr("x1", pX).attr("y1", -config.nodeHeight/2 - 20)
                            .attr("x2", pX).attr("y2", pY + pHeight/2)
                            .attr("stroke", "#999");
                    });
                }
            }

            // 1. Render Main Node Person
            node.each(function(d) {
                renderPerson(d3.select(this), 0, 0, d.data);
                
                // 2. Render Spouse if exists
                if (d.data.spouse) {
                    // Draw connector line (solid pink now)
                    d3.select(this).append("line")
                        .attr("x1", config.nodeWidth/2)
                        .attr("y1", 0)
                        .attr("x2", config.spouseGap - config.nodeWidth/2)
                        .attr("y2", 0)
                        .attr("stroke", "#ff4081")
                        .attr("stroke-width", 2);

                    // Add Heart Icon
                    d3.select(this).append("text")
                        .attr("x", config.spouseGap / 2)
                        .attr("y", 5) // Slight vertical adjustment to center text
                        .attr("text-anchor", "middle")
                        .attr("alignment-baseline", "middle")
                        .style("fill", "#ff4081")
                        .style("font-size", "14px")
                        .text("❤️");

                    renderPerson(d3.select(this), config.spouseGap, 0, d.data.spouse, true);
                }
            });
        }
        
        // Function to toggle children - UPDATED to persist to DATA
        function toggleChildren(d) {
            // We modify d (the data object from JSON) directly, not just the D3 node
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            // Redraw with isUpdate = true to keep zoom
            drawTree(rootData, true);
        }
        
        // --- EXPAND ALL / COLLAPSE ALL ---
        function expandAll() {
            function expand(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expand);
                }
            }
            expand(rootData);
            drawTree(rootData, true);
        }

        function collapseAll() {
            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }
            // Keep the root's children visible to not hide everything completely
             if (rootData.children) {
                rootData.children.forEach(collapse);
            }
            drawTree(rootData, true);
        }
        
        function printView() {
            window.print();
        }

        // --- 5. INTERACTION LOGIC ---

        function searchNode() {
            const query = document.getElementById("searchInput").value.toLowerCase().trim();
            if (!query) return;

            // 1. Reset previous highlights
            d3.selectAll(".person-group").classed("rainbow-highlight", false);

            // 2. Helper to find node and path in the RAW DATA structure
            let foundPath = null;
            
            function searchData(node, currentPath) {
                if (foundPath) return; // Stop if found

                // Check main person
                if (node.name.toLowerCase().includes(query)) {
                    foundPath = [...currentPath, node];
                    return;
                }
                // Check spouse
                if (node.spouse && node.spouse.name.toLowerCase().includes(query)) {
                    // We found the spouse, but we need to expand the main node path
                    foundPath = [...currentPath, node]; 
                    return;
                }

                // Recursive search in children OR _children (hidden ones)
                const kids = node.children || node._children || [];
                for (const child of kids) {
                    searchData(child, [...currentPath, node]);
                }
            }

            // Start search from root
            searchData(rootData, []);

            if (foundPath) {
                // 3. Expand all parents in the path
                foundPath.forEach(node => {
                    if (node._children) {
                        node.children = node._children;
                        node._children = null;
                    }
                });

                // 4. Redraw tree to show expanded nodes
                drawTree(rootData, true);

                // 5. Highlight the matches in the DOM
                const matches = d3.selectAll(".person-group").filter(function() {
                    const dName = d3.select(this).attr("data-name");
                    return dName.includes(query);
                });

                if (!matches.empty()) {
                    matches.classed("rainbow-highlight", true);
                }

            } else {
                alert("No matches found");
            }
        }

        function resetView() {
            document.getElementById("searchInput").value = "";
            
            // Remove highlighting
            d3.selectAll(".person-group").classed("rainbow-highlight", false);
            d3.selectAll(".person-group").classed("highlight", false);

            // Re-center view
            const containerWidth = document.getElementById("tree-container").clientWidth;
            svg.transition().duration(750).call(
                zoom.transform, 
                d3.zoomIdentity.translate(containerWidth/2, 100).scale(0.8)
            );
        }

    </script>
</body>
</html>

