<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Family Tree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- Toolbar --- */
        #toolbar {
            padding: 15px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            z-index: 10;
            align-items: center;
        }

        input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        button { padding: 8px 15px; background-color: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #34495e; }
        button#resetBtn { background-color: #e74c3c; }

        /* --- Tree Canvas --- */
        #tree-container { flex-grow: 1; width: 100%; height: 100%; cursor: grab; }
        #tree-container:active { cursor: grabbing; }

        /* --- Node Styles --- */
        /* Individual Person Box */
        .person-box {
            stroke-width: 2px;
            transition: all 0.3s;
        }
        
        .person-box.male { fill: #fff; stroke: #3498db; }
        .person-box.female { fill: #fff; stroke: #e91e63; }
        
        /* Deceased styling */
        .deceased .person-box { fill: #f4f4f4; stroke-dasharray: 4; }
        .deceased image { filter: grayscale(100%); opacity: 0.7; }

        /* Search Highlight */
        .highlight .person-box {
            stroke: #f1c40f !important;
            stroke-width: 5px !important;
            filter: drop-shadow(0 0 10px #f1c40f);
        }

        /* Text Styles */
        text { font-family: sans-serif; text-anchor: middle; pointer-events: none; }
        .name { font-weight: bold; font-size: 12px; fill: #333; }
        .dates { font-size: 10px; fill: #777; }
        .spouse-label { font-size: 10px; fill: #999; font-style: italic; }

        /* Links */
        .link { fill: none; stroke: #ccc; stroke-width: 2px; }
        .marriage-line { stroke: #333; stroke-width: 2px; }
        .parent-link { stroke: #999; stroke-width: 1px; stroke-dasharray: 2; }
    </style>
</head>
<body>

    <div id="toolbar">
        <h3>Family Tree</h3>
        <input type="text" id="searchInput" placeholder="Search name...">
        <button onclick="searchNode()">Search</button>
        <button id="resetBtn" onclick="resetView()">Reset</button>
    </div>

    <div id="tree-container"></div>

<script>
    // --- Configuration ---
    const config = {
        cardWidth: 120,    // Width of ONE person's box
        cardHeight: 80,    // Height of the box
        gap: 20,           // Gap between husband and wife
        verticalGap: 140   // Vertical space between generations
    };

    const container = d3.select("#tree-container");
    const width = container.node().getBoundingClientRect().width;
    const height = container.node().getBoundingClientRect().height;

    const svg = container.append("svg")
        .attr("width", "100%")
        .attr("height", "100%")
        .call(d3.zoom().on("zoom", (e) => g.attr("transform", e.transform)))
        .append("g");

    const g = svg.append("g").attr("transform", "translate(40,40)");

    // D3 Tree Layout
    // nodeSize is [Width, Height]. Width must accommodate Husband + Wife + Gap
    const tree = d3.tree().nodeSize([config.cardWidth * 2 + 50, config.verticalGap]);

    d3.json("familyData.json").then(data => {
        const root = d3.hierarchy(data);
        update(root);
        
        // Initial Center
        const transform = d3.zoomIdentity.translate(width/2, 100).scale(0.8);
        d3.select("svg").call(d3.zoom().transform, transform);
    }).catch(err => alert("Error loading JSON"));

    function update(root) {
        const treeData = tree(root);
        const nodes = treeData.descendants();
        const links = treeData.links();

        // --- 1. Draw Links (Parent down to Children) ---
        svg.select("g").selectAll(".link")
            .data(links)
            .enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", d => {
                // Connect from center of Parent Group to center of Child Group
                return `M${d.source.x},${d.source.y + config.cardHeight/2}
                        V${d.source.y + config.cardHeight + 40}
                        H${d.target.x}
                        V${d.target.y}`;
            });

        // --- 2. Draw Nodes (Groups) ---
        const nodeGroup = svg.select("g").selectAll(".node")
            .data(nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`);

        // ===============================================
        // RENDER LOGIC: Split Layout
        // ===============================================

        nodeGroup.each(function(d) {
            const group = d3.select(this);
            const main = d.data;
            const spouse = d.data.spouse;

            // -- A. MAIN PERSON (The bloodline) --
            // If there is a spouse, shift main person LEFT. If no spouse, Center them.
            const mainX = spouse ? -(config.cardWidth/2) - (config.gap/2) : 0;
            
            drawPerson(group, main, mainX, 0, "main");

            // -- B. SPOUSE (If exists) --
            if (spouse) {
                const spouseX = (config.cardWidth/2) + (config.gap/2);
                
                // 1. Draw Spouse Box
                drawPerson(group, spouse, spouseX, 0, "spouse");

                // 2. Draw Marriage Line (Connecting the two boxes)
                group.append("line")
                    .attr("class", "marriage-line")
                    .attr("x1", mainX + (config.cardWidth/2))
                    .attr("y1", 0) // Center vertically relative to group
                    .attr("x2", spouseX - (config.cardWidth/2))
                    .attr("y2", 0);
                
                // 3. Draw Heart or Symbol
                group.append("text")
                    .attr("x", 0).attr("y", 5)
                    .style("font-size", "14px")
                    .text("â¤");

                // -- C. SPOUSE'S PARENTS (In-laws) --
                if (spouse.parents && spouse.parents.length > 0) {
                    renderInLaws(group, spouse.parents, spouseX);
                }
            }
        });
    }

    // --- Helper: Draw a Single Person Box ---
    function drawPerson(container, personData, x, y, type) {
        const gid = container.append("g")
            .attr("transform", `translate(${x}, ${y})`)
            .attr("class", d => {
                let c = type === "main" ? "person-group-main" : "person-group-spouse";
                if(personData.status === "deceased") c += " deceased";
                return c;
            })
            // Add data directly to this group for Search functionality
            .datum(personData); 

        // Box
        gid.append("rect")
            .attr("class", `person-box ${personData.gender === 'M' ? 'male' : 'female'}`)
            .attr("width", config.cardWidth)
            .attr("height", config.cardHeight)
            .attr("x", -config.cardWidth/2)
            .attr("y", -config.cardHeight/2)
            .attr("rx", 5);

        // Image
        gid.append("image")
            .attr("xlink:href", personData.img ? `images/${personData.img}` : "https://via.placeholder.com/40")
            .attr("x", -20).attr("y", -config.cardHeight/2 + 10)
            .attr("width", 40).attr("height", 40)
            .attr("clip-path", "circle(20px at center)");

        // Name
        gid.append("text")
            .attr("class", "name")
            .attr("y", 15)
            .text(personData.name);

        // Dates
        gid.append("text")
            .attr("class", "dates")
            .attr("y", 30)
            .text(`${personData.born || "?"} - ${personData.died || ""}`);
    }

    // --- Helper: Render Spouse's Parents (Floating Above) ---
    function renderInLaws(container, parents, centerX) {
        // Line going up from spouse
        container.append("line")
            .attr("class", "parent-link")
            .attr("x1", centerX).attr("y1", -config.cardHeight/2)
            .attr("x2", centerX).attr("y2", -config.cardHeight - 10);

        // Horizontal bar for parents
        container.append("line")
            .attr("class", "parent-link")
            .attr("x1", centerX - 30).attr("y1", -config.cardHeight - 10)
            .attr("x2", centerX + 30).attr("y2", -config.cardHeight - 10);

        parents.forEach((p, index) => {
            // 0 = Dad (Left), 1 = Mom (Right)
            const pX = index === 0 ? centerX - 30 : centerX + 30;
            const pY = -config.cardHeight - 30;

            // Small Box for Parent
            const pGroup = container.append("g")
                .attr("transform", `translate(${pX}, ${pY})`);

            // Connector
            container.append("line")
                .attr("class", "parent-link")
                .attr("x1", pX).attr("y1", -config.cardHeight - 10)
                .attr("x2", pX).attr("y2", pY + 15);

            pGroup.append("rect")
                .attr("width", 50).attr("height", 30)
                .attr("x", -25).attr("y", -15)
                .attr("fill", "#fff")
                .attr("stroke", "#999")
                .attr("rx", 3);

            pGroup.append("text")
                .style("font-size", "8px")
                .attr("y", 4)
                .text(p.name);
        });
    }

    // --- Search ---
    function searchNode() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        d3.selectAll(".person-group-main, .person-group-spouse").classed("highlight", false);
        if(!term) return;

        let found = false;
        d3.selectAll(".person-group-main, .person-group-spouse").each(function(d) {
            if (d.name && d.name.toLowerCase().includes(term)) {
                d3.select(this).classed("highlight", true);
                
                // Zoom logic needs global coordinates of this specific group
                // (Simplified for this demo: just highlighting found nodes)
                found = true;
            }
        });
        
        if(!found) alert("Not found");
    }

    function resetView() {
        d3.selectAll(".highlight").classed("highlight", false);
        document.getElementById('searchInput').value = "";
        const transform = d3.zoomIdentity.translate(width/2, 100).scale(0.8);
        d3.select("svg").transition().duration(750).call(d3.zoom().transform, transform);
    }
</script>
</body>
</html>
