<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Family Tree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --male-color: #e3f2fd;
            --male-border: #2196f3;
            --female-color: #fce4ec;
            --female-border: #e91e63;
            --living-status: #4caf50;
            --deceased-status: #757575;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
        }

        /* Controls Bar */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: #444; }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"], input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        button {
            padding: 8px 16px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover { background-color: #1976d2; }
        button.secondary { background-color: #607d8b; }
        button.secondary:hover { background-color: #455a64; }

        /* Legend */
        #legend {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .legend-item { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        /* SVG Styles */
        #tree-container {
            width: 100vw;
            height: 100vh;
            cursor: grab;
        }
        #tree-container:active { cursor: grabbing; }

        .node rect {
            stroke-width: 2px;
            transition: all 0.3s;
        }

        .node text {
            font-size: 12px;
            font-family: sans-serif;
            text-anchor: middle;
            pointer-events: none;
        }

        .node image {
            clip-path: circle(40%);
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        /* Search Highlight */
        .highlight rect {
            stroke: #ff9800 !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 5px #ff9800);
        }
        
        .deceased { filter: grayscale(100%); opacity: 0.9; }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }

    </style>
</head>
<body>

    <div id="controls">
        <h2>Family Tree Controls</h2>
        
        <div class="control-group">
            <input type="text" id="searchInput" placeholder="Search name...">
            <button onclick="searchNode()">Search</button>
        </div>

        <div class="control-group">
            <button class="secondary" onclick="resetView()">Reset View</button>
        </div>

        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <small>Load external data:</small>
            <input type="file" id="fileInput" accept=".json" onchange="loadUserFile(this)">
        </div>

        <div id="legend">
            <div class="legend-item"><div class="dot" style="background:var(--male-color); border:1px solid var(--male-border);"></div> Male</div>
            <div class="legend-item"><div class="dot" style="background:var(--female-color); border:1px solid var(--female-border);"></div> Female</div>
            <div class="legend-item"><div class="dot" style="border:2px solid var(--living-status);"></div> Living (Green Border)</div>
            <div class="legend-item"><div class="dot" style="border:2px solid var(--deceased-status);"></div> Deceased (Grey Border)</div>
        </div>
    </div>

    <div id="tree-container"></div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        // --- 1. CONFIGURATION & STATE ---
        const config = {
            nodeWidth: 160,
            nodeHeight: 80,
            imageSize: 40,
            siblingGap: 200,
            levelGap: 250,
            spouseGap: 180 // Distance between husband and wife
        };

        let svg, g, zoom;
        let rootData;

        // --- 2. SAMPLE DATA (Fallback) ---
        const sampleData = {
            "name": "Grandpa Joe",
            "gender": "male",
            "status": "deceased",
            "img": "https://via.placeholder.com/150",
            "spouse": {
                "name": "Grandma Josephine",
                "gender": "female",
                "status": "deceased",
                "img": "https://via.placeholder.com/150",
                "parents": [
                    { "name": "Great-Grandpa (Wife's Dad)", "gender": "male", "status": "deceased" },
                    { "name": "Great-Grandma (Wife's Mom)", "gender": "female", "status": "deceased" }
                ]
            },
            "children": [
                {
                    "name": "Uncle Bob",
                    "gender": "male",
                    "status": "living",
                    "spouse": {
                        "name": "Aunt Clarice",
                        "gender": "female",
                        "status": "living"
                    },
                    "children": [
                        { "name": "Cousin Tim", "gender": "male", "status": "living" },
                        { "name": "Cousin Anna", "gender": "female", "status": "living" }
                    ]
                },
                {
                    "name": "Mom",
                    "gender": "female",
                    "status": "living",
                    "spouse": {
                        "name": "Dad",
                        "gender": "male",
                        "status": "living",
                        "parents": [
                            { "name": "Dad's Father", "gender": "male", "status": "deceased" }
                        ]
                    },
                    "children": [
                        { 
                            "name": "Me", 
                            "gender": "male", 
                            "status": "living",
                            "spouse": { "name": "Wife", "gender": "female", "status": "living" },
                            "children": [
                                { "name": "Son", "gender": "male", "status": "living" }
                            ]
                        },
                        { "name": "Sister", "gender": "female", "status": "living" }
                    ]
                }
            ]
        };

        // --- 3. INITIALIZATION ---
        window.onload = function() {
            initTree();
            // Try to fetch 'familyData.json', fall back to sample if fails
            fetch('familyData.json')
                .then(response => {
                    if (!response.ok) throw new Error("File not found");
                    return response.json();
                })
                .then(data => drawTree(data))
                .catch(err => {
                    console.log("Using sample data (Local fetch blocked or file missing).");
                    drawTree(sampleData_Nofallback);
                });
        };

        function initTree() {
            const container = document.getElementById("tree-container");
            const width = container.clientWidth;
            const height = container.clientHeight;

            svg = d3.select("#tree-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(d3.zoom().on("zoom", (e) => {
                    g.attr("transform", e.transform);
                }))
                .on("dblclick.zoom", null); // Disable double click zoom

            g = svg.append("g").attr("transform", "translate(40,40)");
            
            // Set up zoom behavior reference for reset
            zoom = d3.zoom().on("zoom", (e) => g.attr("transform", e.transform));
            svg.call(zoom);
        }

        function loadUserFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    drawTree(data);
                } catch (error) {
                    alert("Invalid JSON file");
                }
            };
            reader.readAsText(file);
        }

        // --- 4. DRAWING LOGIC ---
        function drawTree(data) {
            rootData = data;
            g.selectAll("*").remove(); // Clear previous tree

            // Create hierarchy
            const root = d3.hierarchy(data);

            // Create tree layout
            // We increase node size to account for spouses
            const treeLayout = d3.tree().nodeSize([config.nodeWidth + config.spouseGap, config.levelGap]);
            
            treeLayout(root);

            // Center the tree initially
            const containerWidth = document.getElementById("tree-container").clientWidth;
            const initialX = containerWidth / 2 - root.x;
            const initialY = 100;
            
            svg.call(zoom.transform, d3.zoomIdentity.translate(initialX, initialY).scale(0.8));

            // --- LINKS (Connectors) ---
            
            // 1. Parent to Child links
            g.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => {
                    // Logic: Link starts from bottom center of Parent (or parent+spouse group center)
                    // and goes to top center of Child
                    
                    // If parent has a spouse, the connection point is between them
                    const parentX = d.source.data.spouse ? d.source.x + (config.spouseGap/2) : d.source.x;
                    const parentY = d.source.y + config.nodeHeight / 2; // Bottom of node

                    const childX = d.target.x;
                    const childY = d.target.y - config.nodeHeight / 2; // Top of node

                    return `M${parentX},${parentY} 
                            C${parentX},${(parentY + childY) / 2} 
                             ${childX},${(parentY + childY) / 2} 
                             ${childX},${childY}`;
                });

            // --- NODES ---
            const node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            // Function to render a single person card
            function renderPerson(selection, offsetX, offsetY, personData, isSpouse = false) {
                if (!personData) return;

                const group = selection.append("g")
                    .attr("transform", `translate(${offsetX}, ${offsetY})`)
                    .attr("class", "person-group")
                    .attr("data-name", personData.name.toLowerCase()); // For search

                const color = personData.gender === 'male' ? 'var(--male-color)' : 'var(--female-color)';
                const borderColor = personData.gender === 'male' ? 'var(--male-border)' : 'var(--female-border)';
                const statusColor = personData.status === 'living' ? 'var(--living-status)' : 'var(--deceased-status)';

                // Box
                group.append("rect")
                    .attr("width", config.nodeWidth)
                    .attr("height", config.nodeHeight)
                    .attr("x", -config.nodeWidth / 2)
                    .attr("y", -config.nodeHeight / 2)
                    .attr("rx", 10)
                    .attr("fill", color)
                    .attr("stroke", statusColor) // Status indicates border color
                    .attr("stroke-width", 3);

                // Image (or placeholder)
                group.append("image")
                    .attr("href", personData.img || (personData.gender === 'male' 
                        ? "https://cdn-icons-png.flaticon.com/512/4128/4128176.png" 
                        : "https://cdn-icons-png.flaticon.com/512/4128/4128249.png"))
                    .attr("width", config.imageSize)
                    .attr("height", config.imageSize)
                    .attr("x", -config.nodeWidth / 2 + 10)
                    .attr("y", -config.imageSize / 2);

                // Name
                group.append("text")
                    .attr("dy", "-5")
                    .attr("x", 15) // Shift text right due to image
                    .style("font-weight", "bold")
                    .text(personData.name.length > 15 ? personData.name.substring(0,12)+"..." : personData.name);

                // Status/Details Text
                group.append("text")
                    .attr("dy", "15")
                    .attr("x", 15)
                    .style("font-size", "10px")
                    .text(personData.status.toUpperCase());

                // Visual indicator for Deceased
                if (personData.status === 'deceased') {
                    group.style("filter", "grayscale(0.5)");
                }

                // --- SPOUSE PARENTS (The difficult requirement) ---
                if (isSpouse && personData.parents && personData.parents.length > 0) {
                    const parentGap = 10;
                    const pWidth = 60; 
                    const pHeight = 30;
                    
                    // Draw line up from spouse
                    group.append("line")
                        .attr("x1", 0).attr("y1", -config.nodeHeight/2)
                        .attr("x2", 0).attr("y2", -config.nodeHeight/2 - 20)
                        .attr("stroke", "#999");

                    personData.parents.forEach((parent, i) => {
                        const pX = (i === 0 ? -1 : 1) * (pWidth/2 + 5);
                        const pY = -config.nodeHeight/2 - 40;

                        const pGroup = group.append("g")
                            .attr("transform", `translate(${pX}, ${pY})`);

                        // Parent Box
                        pGroup.append("rect")
                            .attr("width", pWidth)
                            .attr("height", pHeight)
                            .attr("x", -pWidth/2)
                            .attr("y", -pHeight/2)
                            .attr("fill", parent.gender === 'male' ? '#e3f2fd' : '#fce4ec')
                            .attr("stroke", "#ccc");
                        
                        // Parent Name
                        pGroup.append("text")
                            .attr("dy", "4")
                            .style("font-size", "8px")
                            .text(parent.name.split(' ')[0]); // Just first name to save space

                        // Connector to central line
                        group.append("line")
                            .attr("x1", 0).attr("y1", -config.nodeHeight/2 - 20)
                            .attr("x2", pX).attr("y2", -config.nodeHeight/2 - 20)
                            .attr("stroke", "#999");
                        
                        group.append("line")
                            .attr("x1", pX).attr("y1", -config.nodeHeight/2 - 20)
                            .attr("x2", pX).attr("y2", pY + pHeight/2)
                            .attr("stroke", "#999");
                    });
                }
            }

            // 1. Render Main Node Person
            node.each(function(d) {
                renderPerson(d3.select(this), 0, 0, d.data);
                
                // 2. Render Spouse if exists
                if (d.data.spouse) {
                    // Draw connector line between spouses
                    d3.select(this).append("line")
                        .attr("x1", config.nodeWidth/2)
                        .attr("y1", 0)
                        .attr("x2", config.spouseGap - config.nodeWidth/2)
                        .attr("y2", 0)
                        .attr("stroke", "#ff4081")
                        .attr("stroke-width", 2)
                        .attr("stroke-dasharray", "5,5"); // Dashed line for marriage

                    // Render Spouse
                    renderPerson(d3.select(this), config.spouseGap, 0, d.data.spouse, true);
                }
            });
        }

        // --- 5. INTERACTION LOGIC ---

        function searchNode() {
            const query = document.getElementById("searchInput").value.toLowerCase();
            if (!query) return;

            // Reset previous highlights
            d3.selectAll(".person-group").classed("highlight", false);

            // Find matching nodes
            const matches = d3.selectAll(".person-group").filter(function() {
                return d3.select(this).attr("data-name").includes(query);
            });

            if (matches.empty()) {
                alert("No matches found");
                return;
            }

            // Highlight matches
            matches.classed("highlight", true);

            // Zoom to first match
            // We need to find the parent transform of the matched element to center it
            // This is complex in SVG, so we'll just expand the view significantly
            // or reset to center if complex.
            // Simple visual highlight is often enough for this scope.
        }

        function resetView() {
            document.getElementById("searchInput").value = "";
            d3.selectAll(".person-group").classed("highlight", false);
            
            // Animate back to initial state
            const containerWidth = document.getElementById("tree-container").clientWidth;
            const root = d3.hierarchy(rootData); 
            // We re-calculate root just to get X coordinate for centering, 
            // though in a real app we'd cache the initial transform.
            
            svg.transition().duration(750).call(
                zoom.transform, 
                d3.zoomIdentity.translate(containerWidth/2, 100).scale(0.8)
            );
        }

    </script>
</body>
</html>

